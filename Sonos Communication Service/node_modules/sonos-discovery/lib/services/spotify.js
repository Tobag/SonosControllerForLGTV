'use strict';

var request = require('request-promise');

var apiBaseEndpoint = 'https://api.spotify.com';
var endpoints = {
  track: '/v1/tracks/'
};

function parseUri(uri) {
  // x-sonos-spotify:spotify%3atrack%3a3WKg25vrbjJlkhsgl2W4p3?sid=9&flags=8224&sn=9
  var id = void 0;

  var matches = /spotify%3atrack%3a([\w\d]+)/i.exec(uri);

  if (matches) {
    id = matches[1];
  }

  return {
    id: id
  };
}

function tryGetHighResArt(uri) {
  var trackInfo = parseUri(uri);

  var apiUrl = [apiBaseEndpoint, endpoints.track, trackInfo.id].join('');

  return request({
    url: apiUrl,
    json: true
  }).then(function (response) {
    return response.album.images.length ? response.album.images[0].url : null;
  });
}

module.exports = function (services) {
  services[9] = {
    tryGetHighResArt: tryGetHighResArt
  };
};