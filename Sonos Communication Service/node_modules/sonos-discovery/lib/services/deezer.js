'use strict';

var request = require('request-promise');

var apiBaseEndpoint = 'http://api.deezer.com';
var endpoints = {
  track: '/track/'
};

function parseUri(uri) {
  //x-sonosprog-http:tr-flac%3a3134041.flac?sid=2&flags=8224&sn=7

  var uriParts = /x-.+?:.+%3a(\d+)\./.exec(uri);

  var id = uriParts[1];

  return {
    id: id
  };
}

function tryGetHighResArt(uri) {
  var trackInfo = parseUri(uri);

  var apiUrl = [apiBaseEndpoint, endpoints.track, trackInfo.id].join('');

  return request({
    url: apiUrl,
    json: true
  }).then(function (response) {
    return response.album.cover_big; // jscs:ignore requireCamelCaseOrUpperCaseIdentifiers
  });
}

module.exports = function (services) {
  services[2] = {
    tryGetHighResArt: tryGetHighResArt
  };
};