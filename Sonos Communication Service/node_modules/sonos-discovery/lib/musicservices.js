'use strict';

var requireDir = require('./helpers/require-dir');
var services = {};
var logger = require('./helpers/logger');

requireDir(__dirname + '/services', function (register) {
  register(services);
});

function getServiceId(uri) {
  var matches = /sid=(\d+)/.exec(uri);
  if (matches) {
    return matches[1];
  }
}

function tryGetHighResArt(uri) {
  if (uri.startsWith('http')) return Promise.resolve(uri);

  var serviceId = getServiceId(uri);

  if (!services[serviceId]) {
    logger.debug('No such service', uri);
    return Promise.reject('No such service');
  }

  var service = services[serviceId];

  return service.tryGetHighResArt(uri);
}

module.exports = {
  tryGetHighResArt: tryGetHighResArt
};