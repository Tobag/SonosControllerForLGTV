'use strict';

var streamer = require('./streamer');
var flow = require('xml-flow');

function parseServices(servicesXML) {
  var services = {};

  return new Promise(function (resolve, reject) {
    var stream = streamer(servicesXML.availableservicedescriptorlist);
    var sax = flow(stream, { preserveMarkup: flow.NEVER });

    sax.on('tag:service', function (service) {
      var serviceID = parseInt(service.$attrs.id);
      services[service.$attrs.name] = {
        id: serviceID,
        capabilities: parseInt(service.$attrs.capabilities),
        type: (serviceID << 8) + 7
      };
    });

    sax.on('end', function () {
      resolve(services);
    });

    sax.on('error', function (error) {
      reject(error);
    });
  });
}

module.exports = parseServices;