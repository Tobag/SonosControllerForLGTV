'use strict';

var logger = require('../../helpers/logger');

function replaceWithPlaylist(playlistName) {
  var _this = this;

  logger.debug('replacing with playlist ' + playlistName);
  return this.system.getPlaylists().then(function (playlists) {
    logger.debug('found playlists', playlists.map(function (x) {
      return x.title;
    }));
    return playlists.find(function (list) {
      return list.title.toLowerCase() === playlistName.toLowerCase();
    });
  }).then(function (playlist) {
    if (!playlist) {
      throw new Error('Playlist not found');
    }

    logger.debug('clearing queue');
    return _this.clearQueue().then(function () {
      return logger.debug('Adding ' + playlist.uri + ' to queue');
    }).then(function () {
      return _this.addURIToQueue(playlist.uri, '');
    }).then(function () {
      return logger.debug('triggering queue mode');
    }).then(function () {
      return { uri: 'x-rincon-queue:' + _this.uuid + '#0' };
    });
  }).then(function (playlist) {
    logger.debug('setting AVTransport to ' + playlist.uri + ' ');
    return _this.setAVTransport(playlist.uri, '');
  });
}

module.exports = replaceWithPlaylist;