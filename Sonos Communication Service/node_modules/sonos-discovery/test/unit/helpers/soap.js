'use strict';

var expect = require('chai').expect;
var sinon = require('sinon');
var proxyquire = require('proxyquire');
require('chai').use(require('sinon-chai'));
/* jshint -W101 */

describe('soap', function () {
  var request = void 0;
  var soap = void 0;

  beforeEach(function () {
    request = sinon.stub().resolves({ statusCode: 200 });

    soap = proxyquire('../../../lib/helpers/soap', {
      './request': request
    });
  });

  it('Invokes soap call with the correct parameters and returns the promise', function () {
    var result = soap.invoke('http://127.0.0.1/test/path', soap.TYPE.SetEQ, { eqType: 'SubGain', value: -2 });
    expect(request).calledOnce;
    expect(request.firstCall.args[0]).eql({
      uri: 'http://127.0.0.1/test/path',
      method: 'POST',
      headers: {
        'CONTENT-TYPE': 'text/xml; charset="utf-8"',
        SOAPACTION: '"urn:schemas-upnp-org:service:RenderingControl:1#SetEQ"',
        'CONTENT-LENGTH': 312
      },
      body: new Buffer('<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><s:Body><u:SetEQ xmlns:u="urn:schemas-upnp-org:service:RenderingControl:1"><InstanceID>0</InstanceID><EQType>SubGain</EQType><DesiredValue>-2</DesiredValue></u:SetEQ></s:Body></s:Envelope>'),
      stream: true
    });
    expect(result).instanceOf(Promise);
    return result;
  });

  it('Supports calls without values', function () {
    soap.invoke('http://127.0.0.1/test/path', soap.TYPE.Play);
    expect(request).calledOnce;
    expect(request.firstCall.args[0]).eql({
      uri: 'http://127.0.0.1/test/path',
      method: 'POST',
      headers: {
        'CONTENT-TYPE': 'text/xml; charset="utf-8"',
        SOAPACTION: '"urn:schemas-upnp-org:service:AVTransport:1#Play"',
        'CONTENT-LENGTH': 266
      },
      body: new Buffer('<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><s:Body><u:Play xmlns:u="urn:schemas-upnp-org:service:AVTransport:1"><InstanceID>0</InstanceID><Speed>1</Speed></u:Play></s:Body></s:Envelope>'),
      stream: true
    });
  });

  it('Contains templates', function () {
    expect(soap.TYPE).not.empty;
    for (var key in soap.TYPE) {
      var action = soap.TYPE[key];
      expect(soap.TEMPLATES[action], key).not.undefined;
    }
  });
});