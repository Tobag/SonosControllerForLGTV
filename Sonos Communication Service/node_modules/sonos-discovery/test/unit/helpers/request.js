'use strict';

var expect = require('chai').expect;
var sinon = require('sinon');
var proxyquire = require('proxyquire');
var Readable = require('stream').Readable;
require('chai').use(require('sinon-chai'));

describe('request', function () {
  var http = void 0;
  var request = void 0;
  var client = void 0;
  var mockedStream = void 0;

  beforeEach(function () {
    client = {
      on: sinon.spy(),
      end: sinon.spy(),
      write: sinon.spy(),
      setTimeout: sinon.spy()
    };
    http = {
      request: sinon.stub().returns(client)
    };
    request = proxyquire('../../../lib/helpers/request', {
      http: http
    });

    mockedStream = new Readable();

    // Avoid not implemented warning
    mockedStream._read = function noop() {};
  });

  it('Transfers common arguments to http.request', function () {
    request({
      uri: 'http://127.0.0.1:1400/path',
      method: 'SUBSCRIBE',
      headers: {
        'Content-Type': 'text/xml'
      }
    });

    expect(http.request).calledOnce;
    expect(http.request.firstCall.args[0]).eql({
      method: 'SUBSCRIBE',
      path: '/path',
      host: '127.0.0.1',
      port: 1400,
      headers: {
        'Content-Type': 'text/xml'
      }
    });
  });

  it('Sets timeout on client object', function () {
    request({
      uri: 'http://127.0.0.1:1400/path',
      timeout: 10
    });

    expect(client.setTimeout).calledOnce;
    expect(client.setTimeout.firstCall.args[0]).equal(10);
  });

  it('does not call setTimeout if no timeout', function () {
    request({
      uri: 'http://127.0.0.1:1400/path'
    });

    expect(client.setTimeout).not.called;
  });

  it('Defaults to GET and port 80', function () {
    request({
      uri: 'http://127.0.0.1/path'
    });

    expect(http.request).calledOnce;
    expect(http.request.firstCall.args[0]).eql({
      method: 'GET',
      path: '/path',
      host: '127.0.0.1',
      port: 80
    });
  });

  it('Invokes end() to trigger the request', function () {
    request({
      uri: 'http://127.0.0.1/path'
    });

    expect(client.end).calledOnce;
  });

  it('Resolves promise if successful request', function () {
    var body = 'abcdef';
    var promise = request({
      uri: 'http://127.0.0.1/path'
    }).then(function (content) {
      expect(content).equal(body);
    });

    http.request.yield(mockedStream);

    mockedStream.push(body);
    mockedStream.push(null);

    return promise;
  });

  it('Rejects if error occur', function () {
    var promise = request({
      uri: 'http://127.0.0.1/path'
    }).then(function () {
      expect().fail();
    }).catch(function (e) {
      expect(e).instanceOf(Error);
    });

    client.on.withArgs('error').yield(new Error());

    return promise;
  });

  it('Rejects if response code is other than 2xx', function () {
    var promise = request({
      uri: 'http://127.0.0.1/path'
    }).then(function () {
      expect().fail();
    }).catch(function (e) {
      expect(e).instanceOf(Error);
      expect(e.statusCode).equals(500);
    });

    http.request.yield({
      statusCode: 500,
      statusMessage: 'This is an error'
    });

    return promise;
  });

  it('Rejects if timeout occur', function () {
    var promise = request({
      uri: 'http://127.0.0.1/path'
    }).then(function () {
      expect().fail();
    }).catch(function (e) {
      expect(e).instanceOf(Error);
    });

    client.on.withArgs('timeout').yield(new Error());

    return promise;
  });

  it('Returns response object if stream=true', function () {
    var promise = request({
      uri: 'http://127.0.0.1/path',
      stream: true
    }).then(function (res) {
      expect(res).equal(mockedStream);
    });

    mockedStream.statusCode = 200;
    mockedStream.statusMessage = 'OK';

    http.request.yield(mockedStream);
    mockedStream.push(null);

    return promise;
  });

  it('Writes body if exists', function () {
    request({
      uri: 'http://127.0.0.1/path',
      body: 'FOOBAR'
    });

    expect(client.write).calledOnce;
    expect(client.write.firstCall.args[0]).equal('FOOBAR');
  });
});