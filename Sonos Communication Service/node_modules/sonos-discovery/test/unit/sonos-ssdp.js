'use strict';

var expect = require('chai').expect;
var sinon = require('sinon');
var proxyquire = require('proxyquire');
require('chai').use(require('sinon-chai'));

describe('Sonos-SSDP', function () {
  var ssdp = void 0;
  var dgram = void 0;
  var socket = void 0;
  var os = void 0;

  beforeEach(function () {
    socket = {
      bind: sinon.spy(),
      setMulticastTTL: sinon.spy(),
      close: sinon.spy(),
      send: sinon.spy(),
      on: sinon.spy()
    };
    dgram = {
      createSocket: sinon.stub().returns(socket)
    };
    os = {
      networkInterfaces: sinon.stub().returns({
        eth0: [{
          internal: false,
          family: 'IPv4',
          address: '10.0.0.1'
        }]
      })
    };

    ssdp = proxyquire('../../lib/sonos-ssdp', {
      dgram: dgram,
      os: os
    });
  });

  it('Creates listening UDP socket', function () {
    ssdp.start();

    expect(dgram.createSocket).calledOnce;
    expect(socket.bind).calledOnce;
    expect(socket.bind.firstCall.args[0]).equals(1905);
    expect(socket.bind.firstCall.args[1]).equals('0.0.0.0');

    // trigger the callback on bind
    socket.bind.yield();
    expect(socket.setMulticastTTL).calledWith(2);
  });

  it('Sends M-SEARCH data once started', function () {
    ssdp.start();

    // Trigger the listening event callback
    socket.bind.yield();
    expect(socket.send).calledOnce;
    expect(socket.send.firstCall.args[0].toString()).contains('M-SEARCH');
    expect(socket.send.firstCall.args[3]).equals(1900);
    expect(socket.send.firstCall.args[4]).equals('239.255.255.250');
  });

  it('Sends M-SEARCH periodically if no response', function (done) {
    ssdp.start();
    socket.bind.yield();

    setTimeout(function () {
      expect(socket.send).calledTwice;
      done();
    }, 1500);
  });

  it('Switches interface if more than 5 seconds elapse', function (done) {
    this.timeout(10000);
    ssdp.start();
    socket.bind.yield();
    setTimeout(function () {
      expect(socket.bind).calledTwice;
      expect(socket.bind.secondCall.args[1]).equals('10.0.0.1');
      done();
    }, 5500);
  });

  it('Emits upon successful resolve', function () {
    ssdp.start();

    var buffer = ['LOCATION: http://10.0.0.1:1400/device_descriptor.xml', 'X-RINCON-HOUSEHOLD: Sonos_123456789abcdef', 'ST: urn:schemas-upnp-org:device:ZonePlayer:1'].join('\r\n');

    var cb = sinon.spy();

    ssdp.on('found', cb);

    dgram.createSocket.yield(new Buffer(buffer), {
      address: '127.0.0.1'
    });

    expect(cb).calledOnce;
    expect(cb.firstCall.args[0]).eql({
      household: 'Sonos_123456789abcdef',
      ip: '127.0.0.1',
      location: 'http://10.0.0.1:1400/device_descriptor.xml'
    });
  });

  it('Closes socket if stop is invoked', function () {
    ssdp.start();
    ssdp.stop();

    expect(socket.close).calledOnce;
  });
});